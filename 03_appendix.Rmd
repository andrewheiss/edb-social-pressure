---
title: "Appendix analysis"
author: "Andrew Heiss"
date: "Last run: `r format(Sys.time(), '%B %e, %Y')`"
output:
  html_document:
    code_folding: hide
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE}
knitr::opts_chunk$set(cache = FALSE, fig.retina = 2,
                      tidy.opts = list(width.cutoff = 120),  # For code
                      width = 120)  # For output
```

```{r load-libraries-data-functions, message=FALSE, warning=FALSE}
library(tidyverse)
library(broom)
library(countrycode)
library(pander)
library(stargazer)
library(skimr)
library(here)

# By default, R uses polynomial contrasts for ordered factors in linear models
# options("contrasts") 
# So make ordered factors use treatment contrasts instead
options(contrasts = rep("contr.treatment", 2))
# Or do it on a single variable:
# contrasts(df$x) <- "contr.treatment"

# Load pre-cleaned data
edb_clean <- read_rds(file.path(here(), "output", "data", "edb_clean.rds"))
edb_reforms <- read_rds(file.path(here(), "output", "data", "edb_reforms.rds"))

# Load helpful functions
source(file.path(here(), "lib", "model_stuff.R"))
source(file.path(here(), "lib", "graphics_stuff.R"))
```


# Variable descriptions

```{r tbl-vars-description, results="asis", warning=FALSE, message=FALSE}
edb_summary_base <- read_csv(file.path(here(), "data_raw", "variable-summary-base.csv"))

edb_var_descriptions <- edb_summary_base %>%
  mutate(Variable = paste0("`", Variable, "`"))

caption <- "Description of variables used in analysis"

tbl_var_descriptions <- pandoc.table.return(edb_var_descriptions, 
                                            caption = caption, 
                                            split.tables = Inf,
                                            justify = "lll", missing = "")

cat(tbl_var_descriptions)
cat(tbl_var_descriptions, 
    file = file.path(here(), "output", "tables", "app_table_var_desc.md"))
```


# Variable summaries

```{r tbl-vars-summary, results="asis", warning=FALSE, message=FALSE}
edb_summary_stats <- edb_clean %>%
  select(one_of(edb_summary_base$Variable)) %>%
  gather(Variable, value) %>%
  filter(!is.na(value)) %>%
  group_by(Variable) %>%
  summarize(N = n(),
            Mean = mean(value),
            `Std. Dev` = sd(value),
            Min = min(value),
            Max = max(value),
            Distribution = inline_hist(value)) 

edb_summary <- edb_summary_base %>%
  left_join(edb_summary_stats, by = "Variable") %>%
  mutate(Variable = paste0("`", Variable, "`")) %>%
  select(-Definition, -Source)

caption <- "Summary statistics of variables used in analysis"

tbl_edb_summary <- pandoc.table.return(edb_summary, caption = caption, 
                                       big.mark = ",", split.tables = Inf,
                                       justify = "lcccccc")

cat(tbl_edb_summary)
cat(tbl_edb_summary, 
    file = file.path(here(), "output", "tables", "app_table_var_summary.md"))
```


# List of countries in initial 2001 report

\* indicates country has an EDB reform committee by 2015

```{r tbl-countries, warning=FALSE, message=FALSE, results="asis"}
edb_bureaus <- read_csv(file.path(here(), "output", "data", "edb_bureaus.csv"))

country_names <- edb_clean %>%
  filter(in_2001 == 1) %>%
  group_by(ccode) %>%
  summarise(cow = unique(ccode)) %>%
  ungroup() %>%
  mutate(has_committee = ifelse(ccode %in% edb_bureaus$cowcode, "\\*", ""),
         Country = countrycode(cow, "cown", "country.name")) %>%
  mutate(Country = case_when(
    .$cow == 1001 ~ "Serbia",
    .$cow == 1005 ~ "Hong Kong",
    TRUE ~ .$Country
  )) %>%
  arrange(Country) %>%
  mutate(Country = paste0(Country, has_committee)) %>%
  select(Country)

caption <- "Countries in 2001 report"

tbl_countries <- pandoc.table.return(matrix(c(country_names$Country, rep(NA, 2)), 
                                            ncol = 4), caption = caption,
                                     split.tables = Inf, missing = "", justify = "llll")

cat(tbl_countries)
cat(tbl_countries, 
    file = file.path(here(), "output", "tables", "app_table_countries.md"))
```


# How control variables relate to being in the sample and to the outcomes

## Model A1

```{r model-in-2001, results="hide"}
edb_in_2001 <- edb_clean %>%
  filter(year > 2000) %>%
  group_by(ccode) %>%
  mutate(in_2001_lead = lead(in_2001),
         in_2001_lead = factor(in_2001_lead, levels = 0:1, 
                               labels = c("Not in 2001", "In 2001")))

model_in_2001 <- glm(in_2001_lead ~ gdpcap_ln + gdpgrowth + polity + pop_ln + 
                        inttot + civtot + loan_ln, 
                      data = edb_in_2001, family = binomial(link = "logit")) 

model_in_2001_robust <- robust_clusterify(model_in_2001, edb_in_2001, "ccode") %>%
  magrittr::use_series(coefs) %>% tidy()

model_in_2001_out <- stargazer(model_in_2001, type = "html", dep.var.caption = "",
                               dep.var.labels = "in\\_2001\\_lead",
                               se = list(model_in_2001_robust$std.error),
                               notes = "Logit model. Robust standard errors clustered by country.")
```

```{r tbl-model-in-2001, results="asis"}
cat(paste(escape_stars(model_in_2001_out), collapse = "\n"), "\n")
cat(paste(model_in_2001_out, collapse = "\n"), "\n",
    file = file.path(here(), "output", "tables", "app_model_A1.html"))
```

## Models A2–A5

```{r model-check-sb, results="hide"}
# This function generates an R formula based on a given outcome and its lead. 
# Given "sb_days_ln", it will create and run "sb_days_ln_lead ~ sb_days_ln + ..."
run_leaded_ols_check <- function(outcome, df) {
  outcome_lead <- paste0(outcome, "_lead")
  
  form <- as.formula(paste0(outcome_lead, " ~ ", outcome, 
                          " + gdpcap_ln + gdpgrowth + polity + ", 
                          "pop_ln + inttot + civtot + loan_ln"))
  
  lm(form, data = df)
}

# Define all the models that need to be run
models_to_run <- data_frame(outcome = c("sb_days_ln", "sb_proced",
                                        "sb_cost_ln", "sb_capital_ln"),
                            grouping = 1)  # Temporary variable for joining

edb_checks <- edb_clean %>%
  filter(year > 2000, in_2001 == 1) %>%
  mutate(grouping = 1) %>%
  group_by(ccode) %>%
  mutate_at(vars(sb_days_ln, sb_proced, sb_cost_ln, sb_capital_ln),
            funs(lead = lead(.))) %>%
  group_by(grouping) %>%
  nest() %>%
  right_join(models_to_run, by = "grouping")

# Run all the models within the data frame
edb_checks_models <- edb_checks %>%
  mutate(model = pmap(.l = list(outcome, data), run_leaded_ols_check),
         # Add robust clustered SEs
         robust_se = pmap(.l = list(model, data, "ccode"), robust_clusterify),
         # Add a data frame of model parameters with correct SEs
         tidy_robust = robust_se %>% map(~ tidy(.$coef)),
         ses_only = tidy_robust %>% map(~ .$std.error))

edb_checks_models_out <- stargazer(edb_checks_models$model, type = "html", 
                                   dep.var.caption = "",
                                   se = edb_checks_models$ses_only,
                                   notes = "OLS models. Robust standard errors clustered by country.")
```

```{r tbl-model-check-sb, results="asis"}
cat(paste(escape_stars(edb_checks_models_out), collapse = "\n"), "\n")
cat(paste(edb_checks_models_out, collapse = "\n"), "\n",
    file = file.path(here(), "output", "tables", "app_models_A2-5.html"))
```


# Starting a Business indicators

*Not generated with this script.*


# Enforcing Contracts indicators

*Not generated with this script.*


# Policy reform: OLS models

Table 3 from the paper: summary of coefficients for 8 OLS models

TABLE HERE

Full models in the tables below.


# Policy reform: ITS models

Table 4 from the paper: summary of coefficients for 8 ITS models

TABLE HERE

Full models in the tables below.


# Country fixed effects for OLS models


## Table C1

## Table C2

## Table C3


# Year fixed effects for OLS models

## Table D1

## Table D2

## Table D3


# Description of Reform Coding

*Not generated with this script.*


# What explains reform committees?

A bunch of stuff from old repo…


# India experiment survey text

*Not generated with this script.*


# Investor experiment survey text

*Not generated with this script.*
