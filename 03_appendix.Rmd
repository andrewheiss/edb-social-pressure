---
title: "Appendix analysis"
author: "Andrew Heiss"
date: "Last run: `r format(Sys.time(), '%B %e, %Y')`"
output:
  html_document:
    code_folding: hide
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE}
knitr::opts_chunk$set(cache = FALSE, fig.retina = 2,
                      tidy.opts = list(width.cutoff = 120),  # For code
                      width = 120)  # For output
```

```{r load-libraries-data-functions, message=FALSE, warning=FALSE}
library(tidyverse)
library(broom)
library(countrycode)
library(pander)
library(stargazer)
library(skimr)
library(here)

# By default, R uses polynomial contrasts for ordered factors in linear models
# options("contrasts") 
# So make ordered factors use treatment contrasts instead
options(contrasts = rep("contr.treatment", 2))
# Or do it on a single variable:
# contrasts(df$x) <- "contr.treatment"

# Load pre-cleaned data
edb_clean <- read_rds(file.path(here(), "output", "data", "edb_clean.rds"))
edb_reforms <- read_rds(file.path(here(), "output", "data", "edb_reforms.rds"))

# Load helpful functions
source(file.path(here(), "lib", "model_stuff.R"))
source(file.path(here(), "lib", "graphics_stuff.R"))
```


# Variable descriptions

```{r tbl-vars-description, results="asis", warning=FALSE, message=FALSE}
edb_summary_base <- read_csv(file.path(here(), "data_raw", "variable-summary-base.csv"))

edb_var_descriptions <- edb_summary_base %>%
  mutate(Variable = paste0("`", Variable, "`"))

caption <- "Description of variables used in analysis"

tbl_var_descriptions <- pandoc.table.return(edb_var_descriptions, 
                                            caption = caption, 
                                            split.tables = Inf,
                                            justify = "lll", missing = "")

cat(tbl_var_descriptions)
cat(tbl_var_descriptions, 
    file = file.path(here(), "output", "tables", "app_table_var_desc.md"))
```


# Variable summaries

```{r tbl-vars-summary, results="asis", warning=FALSE, message=FALSE}
edb_summary_stats <- edb_clean %>%
  select(one_of(edb_summary_base$Variable)) %>%
  gather(Variable, value) %>%
  filter(!is.na(value)) %>%
  group_by(Variable) %>%
  summarize(N = n(),
            Mean = mean(value),
            `Std. Dev` = sd(value),
            Min = min(value),
            Max = max(value),
            Distribution = inline_hist(value)) 

edb_summary <- edb_summary_base %>%
  left_join(edb_summary_stats, by = "Variable") %>%
  mutate(Variable = paste0("`", Variable, "`")) %>%
  select(-Definition, -Source)

caption <- "Summary statistics of variables used in analysis"

tbl_edb_summary <- pandoc.table.return(edb_summary, caption = caption, 
                                       big.mark = ",", split.tables = Inf,
                                       justify = "lcccccc")

cat(tbl_edb_summary)
cat(tbl_edb_summary, 
    file = file.path(here(), "output", "tables", "app_table_var_summary.md"))
```


# List of countries in initial 2001 report

\* indicates country has an EDB reform committee by 2015

```{r tbl-countries, warning=FALSE, message=FALSE, results="asis"}
edb_bureaus <- read_csv(file.path(here(), "output", "data", "edb_bureaus.csv"))

country_names <- edb_clean %>%
  filter(in_2001 == 1) %>%
  group_by(ccode) %>%
  summarise(cow = unique(ccode)) %>%
  ungroup() %>%
  mutate(has_committee = ifelse(ccode %in% edb_bureaus$cowcode, "\\*", ""),
         Country = countrycode(cow, "cown", "country.name")) %>%
  mutate(Country = case_when(
    .$cow == 1001 ~ "Serbia",
    .$cow == 1005 ~ "Hong Kong",
    TRUE ~ .$Country
  )) %>%
  arrange(Country) %>%
  mutate(Country = paste0(Country, has_committee)) %>%
  select(Country)

caption <- "Countries in 2001 report"

tbl_countries <- pandoc.table.return(matrix(c(country_names$Country, rep(NA, 2)), 
                                            ncol = 4), caption = caption,
                                     split.tables = Inf, missing = "", justify = "llll")

cat(tbl_countries)
cat(tbl_countries, 
    file = file.path(here(), "output", "tables", "app_table_countries.md"))
```


# How control variables relate to being in the sample and to the outcomes

## Model A1

```{r model-in-2001, results="hide"}
edb_in_2001 <- edb_clean %>%
  filter(year > 2000) %>%
  group_by(ccode) %>%
  mutate(in_2001_lead = lead(in_2001),
         in_2001_lead = factor(in_2001_lead, levels = 0:1, 
                               labels = c("Not in 2001", "In 2001")))

model_in_2001 <- glm(in_2001_lead ~ gdpcap_ln + gdpgrowth + polity + pop_ln + 
                        inttot + civtot + loan_ln, 
                      data = edb_in_2001, family = binomial(link = "logit")) 

model_in_2001_robust <- robust_clusterify(model_in_2001, edb_in_2001, "ccode") %>%
  magrittr::use_series(coefs) %>% tidy()

model_in_2001_out <- stargazer(model_in_2001, type = "html", dep.var.caption = "",
                               dep.var.labels = "in\\_2001\\_lead",
                               se = list(model_in_2001_robust$std.error),
                               notes = "Logit model. Robust standard errors clustered by country.",
                               keep.stat = c("n", "rsq", "adj.rsq"))
```

```{r tbl-model-in-2001, results="asis"}
cat(paste(escape_stars(model_in_2001_out), collapse = "\n"), "\n")
cat(paste(model_in_2001_out, collapse = "\n"), "\n",
    file = file.path(here(), "output", "tables", "app_model_A1.html"))
```

## Models A2–A5

```{r model-check-sb, results="hide"}
# This function generates an R formula based on a given outcome and its lead. 
# Given "sb_days_ln", it will create and run "sb_days_ln_lead ~ sb_days_ln + ..."
run_leaded_ols_check <- function(outcome, df) {
  outcome_lead <- paste0(outcome, "_lead")
  
  form <- as.formula(paste0(outcome_lead, " ~ ", outcome, 
                          " + gdpcap_ln + gdpgrowth + polity + ", 
                          "pop_ln + inttot + civtot + loan_ln"))
  
  lm(form, data = df)
}

# Define all the models that need to be run
models_to_run <- data_frame(outcome = c("sb_days_ln", "sb_proced",
                                        "sb_cost_ln", "sb_capital_ln"),
                            grouping = 1)  # Temporary variable for joining

edb_checks <- edb_clean %>%
  filter(year > 2000, in_2001 == 1) %>%
  mutate(grouping = 1) %>%
  group_by(ccode) %>%
  mutate_at(vars(sb_days_ln, sb_proced, sb_cost_ln, sb_capital_ln),
            funs(lead = lead(.))) %>%
  group_by(grouping) %>%
  nest() %>%
  right_join(models_to_run, by = "grouping")

# Run all the models within the data frame
edb_checks_models <- edb_checks %>%
  mutate(model = pmap(.l = list(outcome, data), run_leaded_ols_check),
         # Add robust clustered SEs
         robust_se = pmap(.l = list(model, data, "ccode"), robust_clusterify),
         # Add a data frame of model parameters with correct SEs
         tidy_robust = robust_se %>% map(~ tidy(.$coef)),
         ses_only = tidy_robust %>% map(~ .$std.error))

edb_checks_models_out <- stargazer(edb_checks_models$model, type = "html", 
                                   dep.var.caption = "",
                                   se = edb_checks_models$ses_only,
                                   notes = "OLS models. Robust standard errors clustered by country.",
                                   keep.stat = c("n", "rsq", "adj.rsq"))
```

```{r tbl-model-check-sb, results="asis"}
cat(paste(escape_stars(edb_checks_models_out), collapse = "\n"), "\n")
cat(paste(edb_checks_models_out, collapse = "\n"), "\n",
    file = file.path(here(), "output", "tables", "app_models_A2-5.html"))
```


# Starting a Business indicators

*Not generated with this script.*


# Enforcing Contracts indicators

*Not generated with this script.*


# Policy reform: OLS models

```{r models-ols-all}
# Define all the models that need to be run
models_to_run <- expand.grid(year = 2003:2013,
                             outcome = c("sb_proced", "sb_days_ln",
                                         "sb_cost_ln", "sb_capital_ln"),
                             grouping = c("All countries", 
                                          "No EDB reform committee", 
                                          "Special EDB reform committee"),
                             stringsAsFactors = FALSE)

# As in the paper analysis, this function generates an R model formula based on
# the name of the dependent variable and the year provided. i.e., given
# "sb_proced" and "2005", it will create the formula "sb_proced ~ sb_proced_lag
# + ranked_2005" and run the model
run_lagged_ols_model <- function(outcome, year, df) {
  outcome_lag <- paste0(outcome, "_lag")
  year_variable <- paste0("ranked_", year)

  form <- as.formula(paste0(outcome, " ~ ", outcome_lag, " + ", year_variable))

  lm(form, data = df)
}

dfs_split <- edb_clean %>%
  filter(in_2001 == 1) %>%
  group_by(has_bureau) %>%
  nest() %>%
  mutate(has_bureau = as.character(has_bureau)) %>%
  rename(grouping = has_bureau)

df_all <- edb_clean %>%
  filter(in_2001 == 1) %>%
  mutate(grouping = "All countries") %>%
  group_by(grouping) %>%
  nest()

models_to_run_full <- bind_rows(dfs_split, df_all) %>%
  right_join(models_to_run, by = "grouping")

# Run all the models within the data frame
ols_models_lagged <- models_to_run_full %>%
  mutate(model = pmap(.l = list(outcome, year, data), run_lagged_ols_model),
         # Add robust clustered SEs
         robust_se = pmap(.l = list(model, data, "ccode"), robust_clusterify),
         # Add model summary statistics
         glance = model %>% map(glance),
         # Add a data frame of model parameters with correct SEs
         tidy_robust = robust_se %>% map(~ tidy(.$coef)),
         ses_only = tidy_robust %>% map(~ .$std.error))

# Extract the ranking coefficients from all models
ols_coefs <- ols_models_lagged %>%
  # Spread out the model results
  unnest(tidy_robust) %>%
  # Only look at the ranked* coefficients
  filter(str_detect(term, "ranked")) %>%
  # Clean up the estimates, labels, and add stars
  mutate(value = paste0(sprintf("%.3f", round(estimate, 3)), p_stars(p.value)),
         term = str_replace(term, "\\.\\d+TRUE", "")) %>%
  # Get rid of extra columns
  select(-c(estimate, std.error, statistic, p.value)) %>%
  spread(outcome, value) %>%
  # Give table clean column names
  select(Subset = grouping, Year = year,
         Procedures = sb_proced, `Cost (log)` = sb_cost_ln,
         `Days (log)` = sb_days_ln, `Capital (log)` = sb_capital_ln)
```


## Table 3 from the paper: summary of coefficients for 8 OLS models

Full models in tables B1–3 below.

```{r tbl-ols-in-paper, results="asis"}
tbl_ols_paper <- ols_coefs %>%
  filter(Subset == "All countries", Year %in% c(2005, 2006))

caption <- 'Summary of β~2~ coefficients (i.e. "ranked_200x") for difference models'

tbl_ols <- pandoc.table.return(tbl_ols_paper, caption = caption)

cat(tbl_ols)
cat(tbl_ols, file = file.path(here(), "output", "tables", "app_table_ols.md"))
```

## Table B1: 2005 analysis, full OLS models

```{r tbl-ols-2005-2006, results="hide"}
tbl_ols_2005 <- ols_models_lagged %>%
  filter(grouping == "All countries", year == 2005)

tbl_ols_2005_out <- stargazer(tbl_ols_2005$model, type = "html", 
                              dep.var.caption = "",
                              se = tbl_ols_2005$ses_only,
                              notes = "OLS models. Robust standard errors clustered by country.",
                              keep.stat = c("n", "rsq", "adj.rsq"))

tbl_ols_2006 <- ols_models_lagged %>%
  filter(grouping == "All countries", year == 2006)

tbl_ols_2006_out <- stargazer(tbl_ols_2006$model, type = "html", 
                              dep.var.caption = "",
                              se = tbl_ols_2006$ses_only,
                              notes = "OLS models. Robust standard errors clustered by country.",
                              keep.stat = c("n", "rsq", "adj.rsq"))
```

```{r tbl-ols-2005, results="asis"}
cat(paste(escape_stars(tbl_ols_2005_out), collapse = "\n"), "\n")
cat(paste(tbl_ols_2005_out, collapse = "\n"), "\n",
    file = file.path(here(), "output", "tables", "app_models_B1.html"))
```

## Table B2: 2006 analysis, full OLS models

```{r tbl-ols-2006, results="asis"}
cat(paste(escape_stars(tbl_ols_2006_out), collapse = "\n"), "\n")
cat(paste(tbl_ols_2006_out, collapse = "\n"), "\n",
    file = file.path(here(), "output", "tables", "app_models_B2.html"))
```

## Table B3: Cutpoints at every possible year, OLS models

```{r tbl-ols-all, results="asis"}
caption <- 'Summary of β~2~ coefficients (i.e. "ranked.200x") for difference models for all years'

tbl_ols_all <- pandoc.table.return(ols_coefs, caption = caption,
                                     split.tables = Inf, missing = "—")

cat(tbl_ols_all)
cat(tbl_ols_all, 
    file = file.path(here(), "output", "tables", "app_models_B3_all.md"))
```


# Policy reform: ITS models

```{r models-its-all}
run_its_model <- function(outcome, year, df) {
  year_variable <- paste0("ranked_", year)
  year_centered <- paste0("year_centered_", year)
  
  form <- as.formula(paste0(outcome, " ~ ", year_centered, " + ", year_variable,
                            " + ", year_centered, " * ", year_variable))
  
  lm(form, data = df)
}

# Run all the models within the data frame
its_models_lagged <- models_to_run_full %>%
  mutate(model = pmap(.l = list(outcome, year, data), run_its_model),
         # Add robust clustered SEs
         robust_se = pmap(.l = list(model, data, "ccode"), robust_clusterify),
         # Add model summary statistics
         glance = model %>% map(glance),
         # Add a data frame of model parameters with correct SEs
         tidy_robust = robust_se %>% map(~ tidy(.$coef)),
         ses_only = tidy_robust %>% map(~ .$std.error))

# Extract the ranking coefficients from all models
its_coefs <- its_models_lagged %>%
  # Spread out the model results
  unnest(tidy_robust) %>%
  # Only look at the coefficients from interaction terms (they have ":" in their names)
  filter(str_detect(term, ":")) %>%
  # Clean up the estimates, labels, and add stars
  mutate(value = paste0(sprintf("%.3f", round(estimate, 3)), p_stars(p.value)),
         term = str_replace(term, "(.+)\\.\\d+:(.+)\\.\\d+TRUE", "\\1 × \\2")) %>%
  # Get rid of extra columns
  select(-c(estimate, std.error, statistic, p.value)) %>%
  spread(outcome, value) %>%
  # Give table clean column names
  select(Subset = grouping, Year = year,
         Procedures = sb_proced, `Cost (log)` = sb_cost_ln,
         `Days (log)` = sb_days_ln, `Capital (log)` = sb_capital_ln)
```

## Table 4 from the paper: summary of coefficients for 8 ITS models

Full models in tables C1–3 below.

```{r tbl-its-in-paper, results="asis"}
tbl_its_paper <- its_coefs %>%
  filter(Subset == "All countries", Year %in% c(2005, 2006))

caption <- 'Summary of β~3~ coefficients (i.e. "year.centered.200x × ranked.200x") for ITS models'

tbl_its <- pandoc.table.return(tbl_its_paper, caption = caption)

cat(tbl_its)
cat(tbl_its, file = file.path(here(), "output", "tables", "app_table_its.md"))
```

## Table C1: 2005 analysis, full ITS models

```{r tbl-its-2005-2006, results="hide"}
tbl_its_2005 <- its_models_lagged %>%
  filter(grouping == "All countries", year == 2005)

tbl_its_2005_out <- stargazer(tbl_its_2005$model, type = "html", 
                              dep.var.caption = "",
                              se = tbl_its_2005$ses_only,
                              notes = "ITS models. Robust standard errors clustered by country.",
                              keep.stat = c("n", "rsq", "adj.rsq"))

tbl_its_2006 <- its_models_lagged %>%
  filter(grouping == "All countries", year == 2006)

tbl_its_2006_out <- stargazer(tbl_its_2006$model, type = "html", 
                              dep.var.caption = "",
                              se = tbl_its_2006$ses_only,
                              notes = "ITS models. Robust standard errors clustered by country.",
                              keep.stat = c("n", "rsq", "adj.rsq"))
```

```{r tbl-its-2005, results="asis"}
cat(paste(escape_stars(tbl_its_2005_out), collapse = "\n"), "\n")
cat(paste(tbl_its_2005_out, collapse = "\n"), "\n",
    file = file.path(here(), "output", "tables", "app_models_C1.html"))
```

## Table C2: 2006 analysis, full ITS models

```{r tbl-its-2006, results="asis"}
cat(paste(escape_stars(tbl_its_2006_out), collapse = "\n"), "\n")
cat(paste(tbl_its_2006_out, collapse = "\n"), "\n",
    file = file.path(here(), "output", "tables", "app_models_C2.html"))
```

## Table C3: Cutpoints at every possible year, ITS models

```{r tbl-its-all, results="asis"}
caption <- 'Summary of β~3~ coefficients (i.e. "year.centered.200x × ranked.200x") for ITS models for all years'

tbl_its_all <- pandoc.table.return(its_coefs, caption = caption,
                                   split.tables = Inf, missing = "—")

cat(tbl_its_all)
cat(tbl_its_all, 
    file = file.path(here(), "output", "tables", "app_models_C3_all.md"))
```


# Country fixed effects for OLS models


## Table C1

## Table C2

## Table C3


# Year fixed effects for OLS models

## Table D1

## Table D2

## Table D3


# Description of Reform Coding

*Not generated with this script.*


# What explains reform committees?

A bunch of stuff from old repo…


# India experiment survey text

*Not generated with this script.*


# Investor experiment survey text

*Not generated with this script.*
